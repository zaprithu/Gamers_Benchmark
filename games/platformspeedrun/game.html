<!DOCTYPE html>
<html>
<head>
    <title>Platformer Game</title>
    <style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #000;
            color: #fff;
            font-family: Arial, sans-serif;
        }
        canvas {
            border: 2px solid white;
            display: none;
        }
        #fileInput {
            display: none;
        }
        #startButton {
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <button id="startButton">Start Game</button>
    <input type="file" id="fileInput" accept="image/png">
    <canvas id="gameCanvas"></canvas>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const fileInput = document.getElementById('fileInput');
        const startButton = document.getElementById('startButton');

        const SCALE = 4;
        const PLAYER_WIDTH = 50;
        const PLAYER_HEIGHT = 37;
        const GRAVITY = 0.5;
        const JUMP_FORCE = -12;
        const MOVE_SPEED = 5;
        const SLIDE_DURATION = 1000;
        const WALL_SLIDE_SPEED = 2;

        const gameState = {
            player: {
                x: 0,
                y: 0,
                velocityX: 0,
                velocityY: 0,
                isOnGround: false,
                isOnWall: false,
                isFacingRight: true,
                isSliding: false,
                slideStartTime: 0,
                isWallJumping: false,
                currentAnimation: 'idle',
                animationFrame: 0,
                animationTimer: 0
            },
            keys: {
                w: false,
                a: false,
                s: false,
                d: false,
                space: false,
                shift: false
            }
        };

        const animations = {
            idle: {
                frames: ['adventurer-idle-00.png', 'adventurer-idle-01.png', 'adventurer-idle-02.png', 'adventurer-idle-03.png'],
                frameTime: 150
            },
            run: {
                frames: ['adventurer-run-00.png', 'adventurer-run-01.png', 'adventurer-run-02.png', 
                        'adventurer-run-03.png', 'adventurer-run-04.png', 'adventurer-run-05.png'],
                frameTime: 100
            },
            jump: {
                frames: ['adventurer-jump-00.png', 'adventurer-jump-01.png', 'adventurer-jump-02.png', 'adventurer-jump-03.png'],
                frameTime: 100
            },
            fall: {
                frames: ['adventurer-fall-00.png', 'adventurer-fall-01.png'],
                frameTime: 100
            },
            slide: {
                frames: ['adventurer-slide-00.png', 'adventurer-slide-01.png'],
                frameTime: 100
            },
            slideStandUp: {
                frames: ['adventurer-slide-stand-up-00.png', 'adventurer-slide-stand-up-01.png', 'adventurer-slide-stand-up-02.png'],
                frameTime: 100
            },
            wallCling: {
                frames: ['adventurer-wall-cling-00.png', 'adventurer-wall-cling-01.png'],
                frameTime: 150
            },
            wallJump: {
                frames: ['adventurer-wall-jmp-00.png', 'adventurer-wall-jmp-01.png'],
                frameTime: 100
            }
        };

        const loadedImages = {};
        let mapImage = new Image();
        let mapData = null;
        let imagesLoaded = false;

        function loadImage(name) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    loadedImages[name] = img;
                    resolve();
                };
                img.onerror = () => {
                    console.error(`Failed to load image: ${name}`);
                    reject();
                };
                img.src = name;
            });
        }

        async function loadAllImages() {
            const imagePromises = [];
            
            Object.values(animations).forEach(animation => {
                animation.frames.forEach(frame => {
                    if (!imagePromises.includes(frame)) {
                        imagePromises.push(loadImage(frame));
                    }
                });
            });

            const mapLoadPromise = new Promise((resolve, reject) => {
                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        mapImage.onload = () => {
                            const tempCanvas = document.createElement('canvas');
                            tempCanvas.width = mapImage.width;
                            tempCanvas.height = mapImage.height;
                            const tempCtx = tempCanvas.getContext('2d');
                            tempCtx.drawImage(mapImage, 0, 0);
                            mapData = tempCtx.getImageData(0, 0, mapImage.width, mapImage.height).data;

                            for (let y = 0; y < mapImage.height; y++) {
                                for (let x = 0; x < mapImage.width; x++) {
                                    const i = (y * mapImage.width + x) * 4;
                                    if (mapData[i] === 237 && mapData[i + 1] === 28 && mapData[i + 2] === 36) {
                                        gameState.player.x = x * SCALE;
                                        gameState.player.y = y * SCALE;
                                        break;
                                    }
                                }
                            }
                            resolve();
                        };
                        mapImage.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                };
            });

            imagePromises.push(mapLoadPromise);

            try {
                await Promise.all(imagePromises);
                imagesLoaded = true;
                console.log('All images loaded successfully');
            } catch (error) {
                console.error('Error loading images:', error);
            }
        }

        window.addEventListener('keydown', (e) => {
            switch (e.key.toLowerCase()) {
                case 'w': gameState.keys.w = true; break;
                case 'a': gameState.keys.a = true; break;
                case 's': gameState.keys.s = true; break;
                case 'd': gameState.keys.d = true; break;
                case ' ': gameState.keys.space = true; break;
                case 'shift': gameState.keys.shift = true; break;
            }
        });

        window.addEventListener('keyup', (e) => {
            switch (e.key.toLowerCase()) {
                case 'w': gameState.keys.w = false; break;
                case 'a': gameState.keys.a = false; break;
                case 's': gameState.keys.s = false; break;
                case 'd': gameState.keys.d = false; break;
                case ' ': gameState.keys.space = false; break;
                case 'shift': gameState.keys.shift = false; break;
            }
        });

        function checkCollision(x, y) {
            const mapX = Math.floor(x / SCALE);
            const mapY = Math.floor(y / SCALE);
            if (mapX < 0 || mapX >= mapImage.width || mapY < 0 || mapY >= mapImage.height) {
                return true;
            }
            const i = (mapY * mapImage.width + mapX) * 4;
            return mapData[i] === 127 && mapData[i + 1] === 127 && mapData[i + 2] === 127;
        }

        function updatePlayer() {
            if (!imagesLoaded) return;

            const player = gameState.player;

            if (!player.isSliding) {
                if (gameState.keys.d) {
                    player.velocityX = MOVE_SPEED;
                    player.isFacingRight = true;
                } else if (gameState.keys.a) {
                    player.velocityX = -MOVE_SPEED;
                    player.isFacingRight = false;
                } else {
                    player.velocityX = 0;
                }
            }

            if (gameState.keys.shift && player.isOnGround && !player.isSliding) {
                player.isSliding = true;
                player.slideStartTime = Date.now();
            }

            if (player.isSliding) {
                const slideTimeElapsed = Date.now() - player.slideStartTime;
                if (slideTimeElapsed >= SLIDE_DURATION || !gameState.keys.shift) {
                    player.isSliding = false;
                } else {
                    player.velocityX = player.isFacingRight ? MOVE_SPEED * 1.5 : -MOVE_SPEED * 1.5;
                }
            }

            if (gameState.keys.space && (player.isOnGround || player.isOnWall)) {
                player.velocityY = JUMP_FORCE;
                if (player.isOnWall) {
                    player.velocityX = player.isFacingRight ? -MOVE_SPEED * 1.5 : MOVE_SPEED * 1.5;
                    player.isWallJumping = true;
                    player.isFacingRight = !player.isFacingRight;
                }
                player.isOnGround = false;
                player.isOnWall = false;
            }

            if (!player.isOnGround) {
                if (player.isOnWall) {
                    player.velocityY = WALL_SLIDE_SPEED;
                } else {
                    player.velocityY += GRAVITY;
                }
            }

            let newX = player.x + player.velocityX;
            let newY = player.y + player.velocityY;

            player.isOnGround = false;
            player.isOnWall = false;

            if (checkCollision(newX, player.y)) {
                newX = player.x;
                if (!player.isOnGround) {
                    player.isOnWall = true;
                    player.velocityX = 0;
                }
            }

            if (checkCollision(player.x, newY)) {
                if (player.velocityY > 0) {
                    player.isOnGround = true;
                }
                player.velocityY = 0;
                newY = player.y;
            }

            player.x = newX;
            player.y = newY;

            if (player.isSliding) {
                player.currentAnimation = 'slide';
            } else if (player.isOnWall) {
                player.currentAnimation = 'wallCling';
            } else if (player.isWallJumping) {
                player.currentAnimation = 'wallJump';
            } else if (!player.isOnGround) {
                if (player.velocityY < 0) {
                    player.currentAnimation = 'jump';
                } else {
                    player.currentAnimation = 'fall';
                }
            } else if (Math.abs(player.velocityX) > 0) {
                player.currentAnimation = 'run';
            } else {
                player.currentAnimation = 'idle';
            }

            player.animationTimer++;
            if (player.animationTimer >= animations[player.currentAnimation].frameTime) {
                player.animationTimer = 0;
                player.animationFrame = (player.animationFrame + 1) % animations[player.currentAnimation].frames.length;
            }
        }

        function render() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (!imagesLoaded) {
                ctx.fillStyle = '#fff';
                ctx.font = '20px Arial';
                ctx.fillText('Loading...', canvas.width/2 - 40, canvas.height/2);
                return;
            }

            ctx.drawImage(mapImage, 0, 0, mapImage.width * SCALE, mapImage.height * SCALE);

            const player = gameState.player;
            const currentFrame = animations[player.currentAnimation].frames[player.animationFrame];
            const image = loadedImages[currentFrame];
            
            if (image) {
                ctx.save();
                if (!player.isFacingRight) {
                    ctx.scale(-1, 1);
                    ctx.translate(-player.x - PLAYER_WIDTH * SCALE, player.y);
                } else {
                    ctx.translate(player.x, player.y);
                }
                ctx.drawImage(image, 0, 0, PLAYER_WIDTH * SCALE, PLAYER_HEIGHT * SCALE);
                ctx.restore();
            }
        }

        async function init() {
            canvas.width = 800;
            canvas.height = 600;

            await loadAllImages();

            canvas.width = mapImage.width * SCALE;
            canvas.height = mapImage.height * SCALE;
            
            startButton.style.display = 'none';
            canvas.style.display = 'block';

            function gameLoop() {
                updatePlayer();
                render();
                requestAnimationFrame(gameLoop);
            }

            gameLoop();
        }

        startButton.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', () => {
            init();
        });

    </script>
</body>
</html>